# 3 惯性测量单元 IMU

**姿态更新在本章最后面（比较重要）**

一般IMU设备采集到原始数据存在较大的误差，需要对原始数据进行标定和滤波，经过标定，滤波后的数据，就可以用来进行姿态融合，求出传感器的运动状态，也就是空间的姿态角

消费级：LSM303+L3G4200D组成的九轴方案
				也可以直接用MPU9250，优点单芯片直接集成了九轴IMU传感器
工业级：ADIS16405或ADIS16488A

## 3.1 测量原理

### 3.1.1 加速度测量 
 牛顿第二定律F = ma，线位移，摆式测量，滑动变阻器
 MEMS微机电系统
 
 ### 3.1.2 加速度测量
 高速旋转的陀螺具有定轴性
 
 物体做速度v运动，同时以w角速度转动，这时会产生科氏力F，大小为2*v*w，方向垂直与v，w平面，利用加速度计的测量方法测出科氏力。
 
 ### 3.1.3 地磁测量
  霍尔效应，在磁场中的通电导体块的两侧边会产生电压差。将磁场测量转化成电压测量。
  
  ## 3.2  MPU9250
  支持I2C（400kHZ）和SPI（访问速度：1MHZ-20MHZ）两种通信接口；
  单片机访问传感器的数据是行业通用的做法，采用STM32单片机，常用型号：STM32F103
  
  准备好了9250和STM32两个模块后，把两个模块的引脚用导线连接起来，
  用导线直接连接，电路没有稳定性保障，尺寸也大，外观丑，可以把2个模块集成到电路板上（PCB板子上）
  固件驱动开发（略）
  
  通过STM32单片机的串口将这些数据对外输出，上位机通过串口接收这些数据。
  
  将上面的开发好的IMU模块用串口与上位机进行连接，上位机一般会运行ubuntu和ros系统。
  在上位机上开发对应的ros驱动程序，解析串口中的数据并将结果发布到ROS的话题/imu之中，这样上位机的其他ros程序就可以订阅该话题来获取IMU数据。
  
  加速度计与磁力计的坐标方向并不一致，用变换矩阵T进行转换。
  
  ## 3.3 参数标定
   可以直接使用工具（imu_tk或者imu_utils），不需要阅读下列文字
  
   [标定工具：imu_utils](https://github.com/gaowenliang/imu_utils)
   

  
  IMU测量到的数据精度对实际应用系统（无人机，自动驾驶，机器人，智能穿戴）的整体性能影响非常大，因此需要对IMU采集到的原始数据进行尽可能的补偿，以消除测量已知的测量误差项。
  
 ### 3.3.1 良率检测
  重复上电对零偏的影响、温度对零偏的影响、震荡对零偏的影响、高冲击容忍度，非线性度
  
  ### 3.3.2 内参标定
  
  通过良率检测，对不良IMU进行剔除后，对IMU建立数学模型，对模型中的误差项进行校准的过程叫内参标定。
  ![[Pasted image 20220105124552.png]]
 线性误差模型：模型包含轴偏差项T，尺度偏差项S，零偏项B，
 内参标定就是求解T、S、B
 T （非正交） S（各轴的尺度不一致） B（各轴的零偏（静止状态不为0））
 写成矩阵形式：
![[Pasted image 20220105125736.png]]

#### 标定加速度
将I换成a加速度，在标定加速度a时，需要判断IMU是否处于静止。在t时刻（50秒）分别计算三个轴上的加速度方差，然后利用阈值判读是否静止，小于阈值时为静止。阈值P为经验值，需要具体实验得到。根号下三个方差值的平方和<P.

在静止状态下，加速度测量值的二范数等于当地重力加速度值的二范数，通过经纬度可以确定g的大小。利用最小二乘进行优化问题求解待标定的参数Tacc，Sacc，Bacc;

在静止状态下取N个加速度采样值，构建代价函数，对代价函数最优化求解即可：
可用g2o或者ceres工具。

![[Pasted image 20220105131142.png]]
																											  
上面通过最小二乘方法求解加速度计内参的方法，不需要外部设备，工程中比较方便，缺点需要大量样本。六面法是实验室中标定加速度计的方法，需要借助回转台。	

#### 标定陀螺仪
在静止状态，陀螺仪三轴并没有明显的约束关系，利用静止采集到的角速度样本集，通过求平均值只能得到陀螺仪的零偏B，还需要借助上面经过标定后的加速度信息，才能求出陀螺仪的T和S，
加速度计标定结果直接影响后续的整个IMU的标定结果。
T，S通过运动IMU时，加速度计求的位姿来最小二乘求T，S；

#### 磁力计标定
磁力计通过测量地磁来提供航向信息，测量地磁不需要静止状态下测量。也不需要知道各轴的磁感应强度分量的绝对值，
只需要获得磁力计的三轴分量的相对值。就能表示地磁的方向。
换句话说，只需要求地磁的矢量方向，不需要指定地磁矢量的模。
由于只需要知道地磁的矢量方向，所以磁力计的轴偏和尺度偏差都不需要计算，只标定0偏。

将磁力计以绕8字的方式在空间来回旋转，测量值组成的点将构成一个三维空间椭球面，椭球的球心就是零偏值B。在没有外部电磁干扰的情况下，椭球的球心应该位于坐标轴原点。干扰的情况下，椭球的球心会偏离坐标轴原点。


由于后续要用磁力计测量值与加速度，角速度融合，融合算法通常以加速度计坐标系作为参考。因此需要将磁力计测量值变换到加速度计坐标系下。

在静止状态，加速度计测量值反应重力场信息， 测力计的测量值反应地磁信息，在地球局部区域内，重力和地磁都是不变的。也就是重力和地磁存在一个固定的夹角。

  ### 3.3.3 内参标定改进
  
  温度、重力、轴间灵敏度、Allan方差（陀螺仪除了0偏还有随机游走，随机游走可以理解成高斯噪声上再叠加了一个高斯噪声，这就导致了静止时角速度的平均值并不稳定）


### 3.3.4 外参标定
IMU与其他设备的相对位姿 可以用calibra工具


## 3.4 数据滤波

经过标定后的IMU数据，依然存在抖动、毛刺之类的噪声。要对数据进行滤波，使数据变得平滑。
常见几种传感器去噪的常用的滤波器：均值、滑动、滑动中值、RC低通数字、IIR数字滤波。

  ## 3.5 姿态融合
  

测量得到的加速度和角速度有很大的误差，单纯靠相对运动推算，过不了多久，推算结果就漂移到无法接受的地步。
为解决漂移问题：采用陀螺仪对航姿变化进行估算，另一方面利用重力场和磁场的绝对参考对推算出的航姿进行修正，从而减小漂移，提高航姿计算的精度。

### 数据采集、数据校准、滤波、数据融合
### 最常见的滤波方法：卡尔曼滤波融合算法、互补滤波融合算法
### 3.5.1 卡尔曼滤波
[参考链接](https://blog.csdn.net/qq_31775031/article/details/117067785?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~aggregatepage~first_rank_ecpm_v1~rank_v31_ecpm-10-117067785.pc_agg_new_rank&utm_term=imu%E7%9A%84%E5%8D%A1%E5%B0%94%E6%9B%BC%E6%BB%A4%E6%B3%A2&spm=1000.2123.3001.4430#t0)

[代码gitee下载链接](https://gitee.com/angry-potato/imu-kalman.git)

![[Pasted image 20220105143726.png]]

### 3.5.1 互补滤波

## ** 3.6 姿态更新**
###  3.6.1 方向余弦矩阵微分方程
方向余弦矩阵对时间求导：
**R‘ = R  ·（w^）**

（推导：可有 （R装置）· R = I 对两边同时对时间求导 
							=>R’  ·（R转置）= （-[ (R转置)‘·R ]转置 ） 反对称矩阵可以向量表示		
					
   另一中推导：
   
   一矢量的一导为角速度叉乘该矢量（定轴旋转，相对旋转导数为0）
   
   ![[Pasted image 20220112094437.png]]
							
							
### 3.6.2 方向余弦矩阵姿态更新

![[Pasted image 20220112094943.png]]
  
  **前提定轴旋转：大多选情况我们不是定轴旋转，需要多子样算法补偿效应**
  
  对于**非定轴转动下**的姿态更新方法,主要思路和难点是**通过等效旋转矢量的多子样算法进行不可交换误差补偿**

### 3.6.3 四元数微分方程

![[Pasted image 20220112095831.png]]

### 3.6.4 四元数姿态更新
就是求解微分方程，离散化求解

![[Pasted image 20220112100320.png]]

### 3.6 5 等效旋转矢量微分方程和求解

略

## 3.7 非定轴补偿
![[Pasted image 20220112100818.png]]

![[Pasted image 20220112101108.png]]


补偿不可交换性误差

![[Pasted image 20220112101555.png]]

非定轴旋转的bortz方程：（等效旋转矢量表示的微分方程）

![[Pasted image 20220112101744.png]]


![[Pasted image 20220112102044.png]]

## 3.8 等效旋转矢量进行姿态更新

![[Pasted image 20220112102140.png]]
前一时刻的姿态变化角叉乘后一时刻的姿态变化角，如果是定轴旋转（2个变化角平行，叉乘为0，公式退化成定轴旋转情况） 双子样算法

[公式链接](https://blog.csdn.net/weixin_37781153/article/details/108640423?spm=1001.2101.3001.6650.10&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-10.queryctr&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-10.queryctr&utm_relevant_index=18)
