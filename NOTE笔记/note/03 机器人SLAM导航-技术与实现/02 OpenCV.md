# 2 OpenCV图像处理

ros melodic默认安装了OpenCV3的库，但从CV3版本开始，SIFT,SURF的算法被移植到了opencv_contrib中,因此需要重新安装一下opencv。下载opencv与opencv_contrib对应的版本，
[opencv与opencv_contrib安装教程](https://www.bilibili.com/video/BV17K4y1h7uK/)
## 2.1 访问像素3种方法
在opencv中，图像被存储在Mat类中，Mat类由矩阵头和矩阵指针组成，矩阵头存放矩阵尺寸、存储方法、存储地址等信息；矩阵指针用于指向像素被存放的具体内存区域。
Mat类非常智能，不必手动开辟和释放存储空间，因为OpenCV采用引用机制来进行智能管理。
```
# 创建Mat对象
cv::Mat img(2,2,CV_8UC3,cv::Scalar(1,100,255));
# 创建一个2*2大小的图像，像素点为3通道的RGB彩色，像素值用8位unsigned char数据类型
```

除了Mat类，还有常用其他常用的类：

cv:Point 、cv::Scalar 、cv::Size、 cv::Rect

一些重要函数：
颜色空间转换：cv::cvtColor(),实现RGB，HSV，HSI等颜色空间转换
opencv中默认的图片通道顺序是BGR，蓝绿红
opencv可以通过split和merge函数实现通道分离，通道混合

## 2.2 图像滤波
图像像素之间的关联性，
目的：尽量保留图像特征的条件下，过滤掉噪声，其滤波效果直接影响后续的图像识别、分析等算法的效果。
### 2.2.1 线性滤波
线性滤波（加权求和）：均值、高斯(GaussianBlur)
### 2.2.2 非线性滤波
非线性滤波（特殊的运算：求中值）：中值（medianBlur），双边(bilateralFilter)。
															中值可以去除孤立的噪声（椒盐）
															双边其窗口的加权系数为二维高斯分布，空间位置与像素值相似度有关。
### 2.2.3 形态学滤波
膨胀（dilate）：求局部最大值
腐蚀（erode）：求局部最小值

膨胀与腐蚀进行组合：
开运算（open）  先腐蚀后膨胀
闭运算（close） 先膨胀后腐蚀
形态学梯度（morphgrad） 膨胀图片与腐蚀图片的差值
顶帽运算（tophat） 原图与开的差值
黑帽运算（blackhat） 闭与原图的差值

可以通过形态学滤波函数morphologyEx函数的opt形参来改变不同的形态学滤波方法。

## 2.3 图像变换
重映射remap：把原图中的某个位置的像素放到另一个位置，这样原图所有的像素经过重映射操作得到目标图像。原图像素与目标图像像素的位置一一对应。
									g(x,y) = f(h(x,y))
如：水平翻转、垂直翻转

### 2.3.1 欧式变换
对二维图像的平面做旋转和平移：

![[]9C}0}G$APFE3XLN_~}RYO6.png]]

### 2.3.2 相似变换
在欧式变换矩阵中加上尺度，即缩放

![[QQ图片20220105102706.png]]

### 2.3.3 仿射变换
在相似变换的基础上，将其中的缩放扩展为一般性的情况；即非均匀的缩放。
如：长方形非均匀缩放成的平行四边形

![[Pasted image 20220105103121.png]]

### 2.3.4 射影变换
对仿射变换更一般的推广，将仿射变换中的变换矩阵的0元素变成非0元素，
这让射影变换能有非线性的效果出现，
把原图和目标图像看成三维空间中的两中图像，过某一个公共点进行中心投影，这样就能把原图中的点投射到目标图像上，

注意，这里坐标引入了z坐标。

![[Pasted image 20220105103925.png]]

通过原图的4个点与目标图像的4个点，就能求得射影变换矩阵。

### 2.3.5 求解射影变换矩阵

计算射影变换矩阵方法已经封装到了OpenCV的getPerspectiveTransform函数
射影变换的实现封装到了warpPerspective函数。
 ## 2.4 霍夫变换
 检测直线，极坐标方式，标准霍夫变换与多尺度霍夫变换HoughLines函数
										累计概率霍夫变换HoughLinesP执行效率更高
										
圆检测

## 2.5 边缘检测
边缘检测能提取图像的轮廓
常见的算子：
Sobel：微分求导的方式近似求解图像的梯度，分别求x，y方向的梯度（差分），再合成，
Canny：为提高检测效果，先高斯去除噪声，确定阈值

## 2.6 直方图均衡
图像直方图表示图像中亮点分布的统计图，横坐标为亮度值，纵坐标为每个亮度值对应的像素总数量

如果图像亮度大都中在0-150之间，也就是图像亮度整体偏暗，经过直方图均衡后，亮度均匀分布在0-255区间，图像的明暗度也更加分明。

计算直方图：calcHist函数
直方图均衡化：equalizeHist函数

## 2.7 图像特征点提取

SIFT尺度不变特征变换 
源码：opencv_contrib/modules/xfeatures2d/src/sift.cpp

SURF 加速稳定特征 
源码：opencv_contrib/modules/xfeatures2d/src/surf.cpp

ORB 快速特征点提取与描述
源码：opencv/modules/features2d/src/orb.cpp


### 2.7.1 SIFT尺度不变特征变换 
源码：opencv_contrib/modules/xfeatures2d/src/sift.cpp

sift对图像旋转，尺度，亮度特性保持不变，且对仿射变换，噪声等有较好的稳定性，
sift所有操作都是基于灰度图的，先进行灰度变换。
然后构造高斯金字塔，将高斯金字塔每组中相邻两层求差值得到高斯差分金字塔（DoG金字塔）