# 9 视觉SLAM
 
 数据关联不一样，
 特征点法：数据关联由特征提取和特征匹配；
 直接法：一步到位，直接在图像的像素上完成数据关联。图像灰度信息进行数据关联；
 
 ## 9.1 ORB_SLAM2
 
 相机从不同角度拍摄同一个物体可以得到不同的图像，这些图像有很多相同的信息，这就构成了共视关系。
 
 如何用每帧图像的像素点所包含的信息表示这些共视关系，并利用这些共视关系计算出相机的位姿和环境的地图点。
 
 ### 9.1.1 特征提取
 特征提取算法种类丰富，比如从纹理，灰度统计，频谱，小波变换等信息进行提取。SIFT，SURF，ORB常见的几种特征点法。
 
 特征点包含2部分内容：像素位置和描述子；
 	ORB描述子由二进制组成。
### 9.1.2 特征匹配

opencv已经集成了这些匹配算法

暴力匹配:工作效率低下
K近邻匹配（K Nearest Neighbor，KNN）
快速近似最近邻匹配（Fast Library for Approximate Nearest Neighbor，FLANN）

当环境场景为白墙、地面等重复单一的场景时，极易出现误匹配。

### 9.1.3 构建模型求解位姿与地图点
完成特征提取和特征匹配后，可以构建相应的模型用于相机位姿和地图点的求解。

帧与帧之间的配对特征点，环境地图点，相机位姿等都可以用多视图几何关系来建模。

## 9.2 三维空间运动

相机运动可以看作三维空间中的刚体运动。所谓刚体：物体运动的机械形状不随时间变化。

### 9.2.2 旋转
### 欧拉角：
右手坐标系原则，正前方为x，roll（横滚），pitch（俯仰角）、yaw（航向角）

### 注意
   旋转时必须指明旋转顺序
   内旋（绕一个轴旋转后，其他轴也跟着变化）和外旋（旋转轴是否变化还是固定）
   
   欧拉角存在万向节死锁的问题（三维经纬度 ：维度90，经度失效）丢失自由度，奇异性
   
###  四元数和旋转矩阵
旋转矩阵：9个量，冗余，自身内在约束（正交阵，行列式为1）
四元数：冗余少，缺点物理意义不直观
			  4个量的取值受到内在约束，计算过程中数据的四舍五入会导致四元数取值成为非法值。
			  
欧拉角、四元数、旋转矩阵相互转换，ROStf，Eigen，Matlab，OpenCV等工具都有现成的转换方法。

## 9.3 李群与李代数
李群：具有连续光滑的性质的群。
旋转矩阵构成的群：对乘法封闭。

李代数与李群对应，
李代数由一个集合、一个数域、一个二元运算[ , ],二元运算称为李括号

李代数对用李群的切空间，描述了李群局部的导数。

exp和对数log映射可以实现李代数和流形的转换。

   slam主流方法时优化方法：也就是构造最小二乘的目标函数，不断寻找迭代策略使目标函数逐渐下降，迭代策略基本都时基于导数的。
描述相机位姿的变换矩阵T作为优化变量，在迭代过程中直接对T求导非常困难。如何对T进行优化就成了问题，从矩阵的流形上进行优化的解决方案，更多的是从李群，李代数进行优化的解决方案。

exp(a)*exp(b) = exp(a+b)标量成立，对矩阵不成立，BCH公式近似展开，就可以得到矩阵间的指数乘法运算。

直接求导计算量大，一般采用扰动模型

## 9.4 多视图几何
2d-2d、2d-3d、3d-3d

### 9.4.1 2D-2D

E，H求位姿
三角化求地图点

## # 本质矩阵E，和基础矩阵F（含内参）
E = t^R、 F = (K逆的转置) * E * (K的逆)

0 = p2转置 *F*p1 乘对极约束  每对匹配点带入极线约束得到一个一个方程，8对点就能解8个未知数，8点法

8点法求解出来的E，通过奇异值SVD分解，求出R，t

实际中，5点法（6个自由度，少个一个自由度（公式左右乘非0数还成立），5个自由度，5个未知数，5对点求解）

### 单应性矩阵 H

当被观测的环境点P都位于同一平面，相应图像中的匹配点对就满足单应关系，就是对极约束的一种特殊情况。

p2 = H * p1

E，H在orbslam2初始化过程中使用。

### 三角化重建地图点
三角化，利用三角形关系就能求解出环境点P的深度。

### 9.4.2 3D-2D

单目完成初始化后就得到了一些已知地图点，或者双目，RGBD能直接给出环境点。

多组一一对应的3D地图点与2D特征点，
### PnP问题
DLT：直接线性求解
	一般情况相机K未知，DLT可以同时求出K和内参R，t，（可以实现自标定过程）
	线性方程不是严格=0，构建最小二乘问题。
	
P3P求解：3对点求解3D-2D点就能求出相机运动R，t

EPnP 在求解pnp问题行表现更加稳定，效率，4个控制点和1对对应的参考点pi。

OpenCV的solvePnP()函数集成了求解pnp问题的一些常见的方法，P3P，EPnP、BA优化都可以直接调用这个函数实现。

### 9.4.3 3D-3D

如果知道前后2帧图像中能获得地图点信息，直接根据这个模型就能求出相机位姿。

双目和RGBD都能直接给出环境的观测点

常见求解方法：ICP和BA

### ICP
ICP算法用于求解两组点云之间的位姿变换。
分为点云数据关联已知，和点云数据关联未知解法。

数据关联已知：
2组点云一一对应，构建最小二乘问题。
让每项都最小，SVD求解

数据关联未知：
当给定两组点云个数不一样，有误匹配或者没有匹配信息，要讨论未知数据关联ICP算法的迭代过程。

首先利用某种策略找到点云间的一种数据关联假设，然后按照已知的数据关联的解法求出R，t，不断重复这一个过程知道结果满意为止。
### BA
直接对T和P同时优化。

